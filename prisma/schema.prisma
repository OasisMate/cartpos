datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  // Optional: Use direct connection for migrations if needed
  // directUrl = env("DIRECT_URL")
  // Connection pooling is handled via DATABASE_URL parameters:
  // - Use port 6543 for connection pooler (recommended)
  // - Add pgbouncer=true parameter
  // - Set connection_limit=10 (adjust based on your Supabase plan)
}

generator client {
  provider = "prisma-client-js"
}

// -----------------------------------------------------
// Core: Organizations, Shops, Users, Settings
// Multi-tenant architecture with role-based access control
// -----------------------------------------------------

// Organization: Top-level entity that owns multiple stores
// Managed by Platform Admins and Org Admins
model Organization {
  id               String          @id @default(cuid())
  name             String
  legalName        String?
  type             OrganizationType
  phone            String?
  city             String?
  addressLine1     String?
  addressLine2     String?
  ntn              String?
  strn             String?
  status           OrgStatus       @default(PENDING)
  requestedBy      String?
  approvedBy       String?
  approvedAt       DateTime?
  rejectionReason  String?
  suspensionReason String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  shops       Shop[]
  users       OrganizationUser[]
  activityLogs ActivityLog[]

  @@index([name])
  @@index([status])
  @@index([city])
  @@index([type])
}

enum OrgStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum OrganizationType {
  RETAIL_STORE
  WHOLESALE
  SUPERMARKET
  GENERAL_STORE
  CONVENIENCE_STORE
  PHARMACY
  ELECTRONICS_STORE
  CLOTHING_STORE
  OTHER
}

model Shop {
  id          String        @id @default(cuid())
  orgId       String
  name        String
  city        String?
  phone       String?
  addressLine1 String?
  addressLine2 String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  organization Organization  @relation(fields: [orgId], references: [id])
  owners      UserShop[]
  settings    ShopSettings?
  products    Product[]
  suppliers   Supplier[]
  customers   Customer[]
  invoices    Invoice[]
  purchases   Purchase[]
  stockLedger StockLedger[]
  payments    Payment[]
  customerLedger CustomerLedger[]
  expenses    Expense[]
  activityLogs ActivityLog[]

  @@index([orgId, name])
}

model User {
  id        String      @id @default(cuid())
  name      String
  email     String      @unique
  phone     String?     @unique
  cnic      String?     @unique
  isWhatsApp Boolean   @default(false)
  password  String      // hashed password
  role      UserRole    @default(NORMAL)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  shops            UserShop[]
  organizations    OrganizationUser[]
  createdInvoices  Invoice[]   @relation("InvoiceCreatedBy")
  createdPurchases Purchase[]  @relation("PurchaseCreatedBy")
  passwordResets   PasswordResetToken[]
  expenses         Expense[]
  activityLogs     ActivityLog[]

  @@index([phone])
  @@index([cnic])
  @@index([email])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model UserShop {
  id        String    @id @default(cuid())
  userId    String
  shopId    String
  shopRole  ShopRole
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])
  shop      Shop      @relation(fields: [shopId], references: [id])

  @@unique([userId, shopId])
}

// User role at platform level
enum UserRole {
  PLATFORM_ADMIN  // Full system access, manages all organizations
  NORMAL          // Regular user (role defined at org/shop level)
}

// User role at store level
// STORE_MANAGER: Full store operations (POS, inventory, reports, purchases)
// CASHIER: Limited to POS and personal dashboard
enum ShopRole {
  STORE_MANAGER  // Renamed from SHOP_OWNER (v1.1.0)
  CASHIER
}

// User role at organization level
// Links users to organizations with specific permissions
model OrganizationUser {
  id        String   @id @default(cuid())
  userId    String
  orgId     String
  orgRole   OrgRole
  createdAt DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [orgId], references: [id])

  @@unique([userId, orgId])
}

enum OrgRole {
  ORG_ADMIN
}

model ShopSettings {
  id                              String        @id @default(cuid())
  shopId                          String        @unique
  requireCostPriceForStockItems   Boolean       @default(false)
  requireBarcodeForProducts       Boolean       @default(false)
  allowCustomUnits                Boolean       @default(true)
  allowNegativeStock              Boolean       @default(true)  // Allow sales even if stock is insufficient
  languageMode                    LanguageMode  @default(EN_BILINGUAL)
  printerName                     String?       // Preferred printer name (for reference, actual selection handled by browser)
  autoPrint                       Boolean       @default(false)  // Auto-print receipts after sale completion
  logoUrl                         String?       // Store logo image URL (PNG format)
  receiptHeaderDisplay            ReceiptHeaderDisplay @default(NAME_ONLY)  // What to show on receipt header
  shop                            Shop          @relation(fields: [shopId], references: [id])
}

enum LanguageMode {
  EN_ONLY
  EN_BILINGUAL    // v1
  URDU_EN         // future
}

enum ReceiptHeaderDisplay {
  NAME_ONLY       // Show only store name
  LOGO_ONLY       // Show only logo
  BOTH            // Show both name and logo
}

// -----------------------------------------------------
// Products & Stock
// -----------------------------------------------------

model Product {
  id           String         @id @default(cuid())
  shopId       String
  name         String
  sku          String?
  barcode      String?
  unit         String
  price        Decimal        @db.Decimal(10, 2)
  cartonPrice  Decimal?       @db.Decimal(10, 2)  // Price for full carton
  costPrice    Decimal?       @db.Decimal(10, 2)
  category     String?
  trackStock   Boolean        @default(true)
  reorderLevel Int?
  cartonSize   Int?           // Number of pieces in a carton
  cartonBarcode String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  shop         Shop           @relation(fields: [shopId], references: [id])
  invoiceLines InvoiceLine[]
  purchaseLines PurchaseLine[]
  stockLedger  StockLedger[]

  @@index([shopId, name])
  @@unique([shopId, barcode], map: "unique_barcode_per_shop")
  @@index([shopId, barcode])
}

model StockLedger {
  id          String         @id @default(cuid())
  shopId      String
  productId   String
  changeQty   Decimal        @db.Decimal(10, 3) // quantity can be fractional
  type        StockMoveType
  refType     String?        // e.g. "purchase_line", "invoice_line", "adjustment"
  refId       String?
  createdAt   DateTime       @default(now())
  shop        Shop           @relation(fields: [shopId], references: [id])
  product     Product        @relation(fields: [productId], references: [id])

  @@index([shopId, productId])
  @@index([shopId, productId, type])
  @@index([shopId, createdAt])
}

enum StockMoveType {
  PURCHASE
  SALE
  ADJUSTMENT
  DAMAGE
  EXPIRY
  RETURN
  SELF_USE
}

// -----------------------------------------------------
// Suppliers & Purchases
// -----------------------------------------------------

model Supplier {
  id        String     @id @default(cuid())
  shopId    String
  name      String
  phone     String?
  address   String?
  notes     String?
  createdAt DateTime   @default(now())
  shop      Shop       @relation(fields: [shopId], references: [id])
  purchases Purchase[]

  @@index([shopId, name])
}

model Purchase {
  id              String         @id @default(cuid())
  shopId          String
  supplierId      String?
  date            DateTime       @default(now())
  reference       String?
  notes           String?
  createdByUserId String?
  createdAt       DateTime       @default(now())
  shop            Shop           @relation(fields: [shopId], references: [id])
  supplier        Supplier?      @relation(fields: [supplierId], references: [id])
  lines           PurchaseLine[]
  createdBy       User?          @relation("PurchaseCreatedBy", fields: [createdByUserId], references: [id])

  @@index([shopId, date])
}

model PurchaseLine {
  id          String          @id @default(cuid())
  purchaseId  String
  productId   String
  quantity    Decimal         @db.Decimal(10, 3)
  unitCost    Decimal?        @db.Decimal(10, 2)
  createdAt   DateTime        @default(now())
  purchase    Purchase        @relation(fields: [purchaseId], references: [id])
  product     Product         @relation(fields: [productId], references: [id])

  @@index([purchaseId])
}

// -----------------------------------------------------
// Customers & Udhaar
// -----------------------------------------------------

model Customer {
  id        String           @id @default(cuid())
  shopId    String
  name      String
  phone     String?
  notes     String?
  createdAt DateTime         @default(now())
  shop      Shop             @relation(fields: [shopId], references: [id])
  invoices  Invoice[]
  ledger    CustomerLedger[]
  payments  Payment[]

  @@index([shopId, name])
  @@index([shopId, phone])
}

model CustomerLedger {
  id          String             @id @default(cuid())
  shopId      String
  customerId  String
  type        CustomerEntryType
  direction   LedgerDirection
  amount      Decimal            @db.Decimal(10, 2)
  refType     String?
  refId       String?
  createdAt   DateTime           @default(now())
  shop        Shop               @relation(fields: [shopId], references: [id])
  customer    Customer           @relation(fields: [customerId], references: [id])

  @@index([shopId])
  @@index([customerId])
  @@index([customerId, createdAt])
  @@index([shopId, customerId])
}

enum CustomerEntryType {
  SALE_UDHAAR
  PAYMENT_RECEIVED
  ADJUSTMENT
}

enum LedgerDirection {
  DEBIT   // customer owes more
  CREDIT  // owes less
}

// -----------------------------------------------------
// Sales, Invoices, Payments
// -----------------------------------------------------

model Invoice {
  id              String          @id @default(cuid())
  shopId          String
  customerId      String?
  number          String?         // human-readable invoice no., optional
  status          InvoiceStatus   @default(COMPLETED)
  paymentStatus   PaymentStatus
  paymentMethod   PaymentMethod?  // null for UDHAAR
  subtotal        Decimal         @db.Decimal(10, 2)
  discount        Decimal         @default(0) @db.Decimal(10, 2)
  total           Decimal         @db.Decimal(10, 2)
  createdByUserId String?
  createdAt       DateTime        @default(now())
  shop            Shop            @relation(fields: [shopId], references: [id])
  customer        Customer?       @relation(fields: [customerId], references: [id])
  lines           InvoiceLine[]
  payments        Payment[]
  createdBy       User?           @relation("InvoiceCreatedBy", fields: [createdByUserId], references: [id])

  @@index([shopId, createdAt])
  @@index([shopId, status])
  @@index([shopId, paymentStatus])
  @@index([shopId, paymentStatus, createdAt])
}

model InvoiceLine {
  id          String     @id @default(cuid())
  invoiceId   String
  productId   String
  quantity    Decimal    @db.Decimal(10, 3)
  unitPrice   Decimal    @db.Decimal(10, 2)
  lineTotal   Decimal    @db.Decimal(10, 2)
  createdAt   DateTime   @default(now())
  invoice     Invoice     @relation(fields: [invoiceId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])

  @@index([invoiceId])
}

enum InvoiceStatus {
  COMPLETED
  VOID
}

enum PaymentStatus {
  PAID
  UDHAAR
  PARTIAL  // for future
}

enum PaymentMethod {
  CASH
  CARD
  OTHER
}

model Payment {
  id          String          @id @default(cuid())
  shopId      String
  invoiceId   String?
  customerId  String?
  amount      Decimal         @db.Decimal(10, 2)
  method      PaymentMethod
  note        String?
  createdAt   DateTime        @default(now())
  shop        Shop            @relation(fields: [shopId], references: [id])
  invoice     Invoice?        @relation(fields: [invoiceId], references: [id])
  customer    Customer?       @relation(fields: [customerId], references: [id])

  @@index([shopId, createdAt])
}

// -----------------------------------------------------
// Expenses
// -----------------------------------------------------

model Expense {
  id          String   @id @default(cuid())
  shopId      String
  userId      String
  amount      Decimal  @db.Decimal(10, 2)
  category    String
  description String?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shop Shop @relation(fields: [shopId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([shopId, date])
}

// -----------------------------------------------------
// Activity Log (Audit Trail)
// -----------------------------------------------------

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  orgId       String
  shopId      String?
  action      String   // CREATE_STORE, UPDATE_USER, etc.
  entityType  String   // STORE, USER, PRODUCT, SALE, etc.
  entityId    String?
  details     Json?    // Additional context (old values, new values, etc.)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now()) @db.Timestamptz // Stored in UTC/GMT
  
  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [orgId], references: [id])
  shop         Shop?        @relation(fields: [shopId], references: [id])
  
  @@index([orgId, createdAt])
  @@index([shopId, createdAt])
  @@index([userId, createdAt])
  @@index([action])
}

